pipeline { 
    agent any

    environment {
        DOCKER_REGISTRY = "docker.io/dvduong"
        APP_NAME        = "final-lab-frontend"
        IMAGE_TAG       = "${env.BUILD_NUMBER}"
        GIT_REPO_URL    = "https://github.com/doduong27/Devops_Application_Lab_Testing.git"
    }

    stages {
        stage('üì¶ Install & Build') {
            agent {
                docker { 
                    image 'node:16-alpine' 
                    // Quan tr·ªçng: Node 16 kh√¥ng c·∫ßn openssl-legacy-provider
                }
            }
            steps {
                dir('-final-lab/frontend') {
                    sh 'npm install'
                    sh 'npm run build'
                }
            }
        }

        stage('üé® Lint Check') {
            steps {
                dir('-final-lab/frontend') {
                    sh 'npm run lint || true' // Tr√°nh d·ª´ng pipeline n·∫øu ch·ªâ l√† warning
                }
            }
        }

        stage('üß™ Frontend Test') {
            steps {
                dir('-final-lab/frontend') {
                    sh 'npm test -- --watchAll=false || true' 
                }
            }
        }

/*        stage('üèó Build Production') {
            agent {
                docker { 
                    image 'node:16-alpine' 
                    // Quan tr·ªçng: Node 16 kh√¥ng c·∫ßn openssl-legacy-provider
                }
            }
            steps {
                dir('-final-lab/frontend') {
                    sh 'npm run build'
                }
            }
        }
*/
        stage('üê≥ Dockerize & Push') {
            steps {
                script {
                    withDockerRegistry([credentialsId: 'docker-credentials', url: '']) {
                        dir('-final-lab/frontend') {
                        // Frontend th∆∞·ªùng d√πng Nginx ƒë·ªÉ serve, Dockerfile n√™n n·∫±m trong th∆∞ m·ª•c frontend
                        def frontendImg = docker.build("dvduong/frontend:${env.BUILD_ID}")
                        frontendImg.push()
                        frontendImg.push("latest")
                        }
                    }
                }
            }
        }

        stage('üöÄ Release (GitOps Update)') {
            steps {
                dir('-final-lab/k8s') {
                sh """
                    sh "sed -i 's|image: .*/frontend:.*|image: docker.io/dvduong/frontend:${env.BUILD_NUMBER}|g' deployment_frontend.yaml"
                    git add deployment_frontend.yaml
                    git commit -m "chore: update frontend image to ${IMAGE_TAG}"
                    git push origin main
                """
                }
            }
        }
    }
}