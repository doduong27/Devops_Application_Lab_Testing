pipeline { 
    agent {
        docker {
            image 'node:18-alpine' // Ho·∫∑c phi√™n b·∫£n node b·∫°n ƒëang d√πng
        }
    }

    environment {
        DOCKER_REGISTRY = "docker.io/dvduong"
        APP_NAME        = "final-lab-frontend"
        IMAGE_TAG       = "${env.BUILD_NUMBER}"
        GIT_REPO_URL    = "https://github.com/doduong27/Devops_Application_Lab_Testing.git"
    }

    stages {
        stage('üì¶ Install Dependencies') {
            steps {
                dir('-final-lab/frontend') {
                    sh 'npm install'
                }
            }
        }

        stage('üé® Lint Check') {
            steps {
                dir('-final-lab/frontend') {
                    sh 'npm run lint || true' // Tr√°nh d·ª´ng pipeline n·∫øu ch·ªâ l√† warning
                }
            }
        }

        stage('üß™ Frontend Test') {
            steps {
                dir('-final-lab/frontend') {
                    sh 'npm test -- --watchAll=false'
                }
            }
        }

        stage('üèó Build Production') {
            steps {
                dir('-final-lab/frontend') {
                    sh 'npm run build'
                }
            }
        }

        stage('üê≥ Dockerize & Push') {
            steps {
                script {
                    docker.withRegistry("https://${DOCKER_REGISTRY}", "docker-credentials") {
                        // Frontend th∆∞·ªùng d√πng Nginx ƒë·ªÉ serve, Dockerfile n√™n n·∫±m trong th∆∞ m·ª•c frontend
                        def frontendImg = docker.build("${DOCKER_REGISTRY}/${APP_NAME}:${IMAGE_TAG}", "-f frontend/Dockerfile frontend/")
                        frontendImg.push()
                    }
                }
            }
        }

        stage('üöÄ Release (GitOps Update)') {
            steps {
                sh """
                    sed -i "s|image: .*/frontend-server:.*|image: ${DOCKER_REGISTRY}/${APP_NAME}:${IMAGE_TAG}|g" k8s/deployment.yaml
                    git add k8s/deployment.yaml
                    git commit -m "chore: update frontend image to ${IMAGE_TAG}"
                    git push origin main
                """
            }
        }
    }
}