pipeline { 
    agent {
        docker {
            image 'node:16-alpine' // Hoáº·c phiÃªn báº£n node báº¡n Ä‘ang dÃ¹ng
        }
    }

    environment {
        DOCKER_REGISTRY = "docker.io/dvduong"
        APP_NAME        = "final-lab-frontend"
        IMAGE_TAG       = "${env.BUILD_NUMBER}"
        GIT_REPO_URL    = "https://github.com/doduong27/Devops_Application_Lab_Testing.git"
    }

    stages {
        stage('ğŸ“¦ Install Dependencies') {
            steps {
                dir('-final-lab/frontend') {
                    sh 'npm install'
                }
            }
        }

        stage('ğŸ¨ Lint Check') {
            steps {
                dir('-final-lab/frontend') {
                    sh 'npm run lint || true' // TrÃ¡nh dá»«ng pipeline náº¿u chá»‰ lÃ  warning
                }
            }
        }

        stage('ğŸ§ª Frontend Test') {
            steps {
                dir('-final-lab/frontend') {
                    sh 'npm test -- --watchAll=false || true' 
                }
            }
        }

        stage('ğŸ— Build Production') {
            steps {
                dir('-final-lab/frontend') {
                    sh 'npm run build'
                }
            }
        }

        stage('ğŸ³ Dockerize & Push') {
            steps {
                script {
                    withDockerRegistry([credentialsId: 'docker-credentials', url: '']) {
                        dir('-final-lab/frontend') {
                        // Frontend thÆ°á»ng dÃ¹ng Nginx Ä‘á»ƒ serve, Dockerfile nÃªn náº±m trong thÆ° má»¥c frontend
                        def frontendImg = docker.build("${DOCKER_REGISTRY}/${APP_NAME}:${IMAGE_TAG}", "-f frontend/Dockerfile frontend/")
                        frontendImg.push()
                        }
                    }
                }
            }
        }

        stage('ğŸš€ Release (GitOps Update)') {
            steps {
                sh """
                    sed -i "s|image: .*/frontend-server:.*|image: ${DOCKER_REGISTRY}/${APP_NAME}:${IMAGE_TAG}|g" k8s/deployment.yaml
                    git add k8s/deployment.yaml
                    git commit -m "chore: update frontend image to ${IMAGE_TAG}"
                    git push origin main
                """
            }
        }
    }
}