pipeline {
    agent any
    environment {
        DOCKER_REGISTRY = "docker.io/dvduong"
        APP_NAME        = "final-lab-backend"
        IMAGE_TAG       = "${env.BUILD_NUMBER}"
        GIT_REPO_URL    = "https://github.com/doduong27/Devops_Application_Lab_Testing.git"
    }

    stages {
        stage('üîç Backend Lint') {
            steps {
                dir('-final-lab/backend') {
                    echo 'Running Go Vet...'
                    sh 'go vet ./...'
                }
            }
        }

        stage('üß™ Backend Unit Test') {
            steps {
                dir('-final-lab/backend') {
                    echo 'Running Go Tests...'
                    sh 'go test -v ./...'
                }
            }
        }

        stage('üì¶ Build Binary') {
            steps {
                dir('-final-lab/backend') {
                    sh 'go build -o main app.go'
                }
            }
        }

        stage('üê≥ Dockerize & Push') {
            steps {
                script {
                    docker.withRegistry("https://${DOCKER_REGISTRY}", "docker-credentials") {
                        def backendImg = docker.build("${DOCKER_REGISTRY}/${APP_NAME}:${IMAGE_TAG}", "-f backend/Dockerfile backend/")
                        backendImg.push()
                    }
                }
            }
        }

        stage('üöÄ Release (GitOps Update)') {
            steps {
                sh """
                    # C·∫≠p nh·∫≠t ch√≠nh x√°c ƒë·ªãa ch·ªâ registry v√† tag m·ªõi v√†o file YAML
                    sed -i "s|image: .*/backend-server:.*|image: ${DOCKER_REGISTRY}/${APP_NAME}:${IMAGE_TAG}|g" k8s/deployment.yaml
                    git add k8s/deployment.yaml
                    git commit -m "chore: update backend image to ${IMAGE_TAG}"
                    git push origin main
                """
            }
        }
    }
}